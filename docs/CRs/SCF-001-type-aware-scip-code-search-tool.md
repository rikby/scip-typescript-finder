---
code: SCF-001
status: Implemented
dateCreated: 2025-12-30T14:26:42.205Z
type: Feature Enhancement
priority: Medium
implementationDate: 2026-01-01
---

# Type-Aware SCIP Code Search Tool

## 1. Description

### Requirements Scope
`full` — Full EARS + FR + NFR specifications

### Problem
- Current code search cannot distinguish same-named symbols from different files (e.g., `Ticket` interface from `shared/models/Ticket.ts` vs `src/types.ts`)
- String-based search produces false positives when same identifier names exist across different modules
- No way to track type-aware import/export dependencies across codebase
- Refactoring impact analysis requires manual trace of symbol usage

### Affected Areas
- **Project**: `./src` directory within scip-finder
- **CLI tools**: `scip-find` command for symbol search
- **Shared code**: SCIP parsing and query utilities
- **Tests**: Unit tests + integration tests using markdown-ticket project + synthetic cases
### Scope
- **In scope**: Type-aware symbol search using SCIP protocol, CLI interface for querying symbols
- **Out of scope**: Real-time SCIP watching, LSP integration, web UI

## 2. Desired Outcome
### Success Conditions
- When querying a symbol name with its defining file, system returns only usages of that specific symbol (not same-named symbols from other files)
- Users can find all references to a type/interface across the entire codebase
- System distinguishes between import statements, type annotations, function calls, and inheritance relationships
- Search completes in under 1 second for codebases up to 100k LOC

### Constraints
- Must use existing SCIP files generated by `scip-typescript` (no rebuild requirement)
- Must work with TypeScript codebase
- Must handle same-named symbols from different source files correctly

### Non-Goals
- Not creating a real-time file watcher for SCIP regeneration
- Not building editor/LSP integration
- Not providing visual dependency graph UI

### Architecture Design
## Architecture Design

> **Extracted**: Complex architecture — see [architecture.md](./SCF-001/architecture.md)

**Summary**:
- Pattern: Repository Pattern with in-memory symbol index
- Components: 5 (CLI Parser, SCIP Loader, Symbol Indexer, Query Engine, Formatters)
- Key constraint: Query performance < 1s target (validated: 0.03ms average)
- Dependencies: `commander@^12.0.0` (CLI), `protobufjs@^8.0.0` (SCIP parsing)

**Implementation Phases**: 4 phases — Foundation → Query Core → CLI + Output → Hardening
**Optional**: Performance benchmarks (can be done anytime after Phase 3)

**Extension Rule**: To add output format, create formatter in `output/` (limit 100 lines), add `.option()` to commander in `cli/index.ts`
## 3. Open Questions
| Area | Question | Constraints |
|------|----------|-------------|
| SCIP Library | Which SCIP parsing library to use? | Must parse Protocol Buffer format |
| Data Structure | What data structure for efficient symbol lookup? | Must support queries < 1 second |
| Project Integration | How to integrate with existing monorepo structure? | Must work with project layout |

### Known Constraints
- SCIP protocol uses Protocol Buffer binary format
- `scip-typescript` generates `index.scip` files
- Symbol names encode file paths and type information

### Resolved 2025-12-30
- **Project location**: `./src` directory
- **CLI command name**: `scip-find`
- **Output formats**: Text (grep-like) + JSON (programmatic)
- **Test approach**: Both markdown-ticket (real) + synthetic (edge cases)

### Decisions Deferred
- Specific SCIP parsing library choice (determined by `/mdt:architecture`)
- In-memory data structure for symbol lookup (determined by `/mdt:architecture`)
- Exact CLI option syntax (determined by `/mdt:architecture`)
## 4. Acceptance Criteria
### Functional (Outcome-focused)
- [ ] `scip-find Ticket --from shared/models/Ticket.ts --folder shared/` returns all usages in `shared/` folder
- [ ] `scip-find Ticket --from shared/models/Ticket.ts` returns all usages across entire project
- [ ] Output includes file path, line number, and role (import/type annotation/call/inheritance)
- [ ] `--format json` option produces structured JSON output
- [ ] `--format text` option produces grep-like plain text output
- [ ] Same-named symbols from different files are correctly distinguished
### Non-Functional
- [ ] Query response time < 1 second for codebases up to 100k LOC
- [ ] 100% precision (no false positives from same-named symbols)
- [ ] 100% recall (find all actual references)

### Edge Cases
- What happens when SCIP file is missing or corrupted
- What happens when symbol definition cannot be found
- What happens when multiple symbols have same name in same file (overloads)

> Full EARS requirements: [requirements.md](./SCF-001/requirements.md)

> **Extracted**: Complex architecture — see [architecture-phase6.md](./SCF-001/architecture-phase6.md)

**Summary**:
- **Pattern**: Resolver Pattern — decouples symbol resolution from storage/query layers
- **Components**: 7 (5 new files, 2 modified files)
- **Key constraint**: Pre-resolution at index build time (10-15ms overhead, zero query overhead)
- **Total new code**: ~355 lines (limit), ~535 lines (hard max)

**Core Achievement**: Enables cross-package `--from` queries
```bash
scip-find Ticket --from models/Ticket.ts \
  --scip shared/index.scip \
  --scip markdown-ticket/index.scip
# Now finds usages in markdown-ticket that import from @mdt/shared ✅
```

**Validated Decisions** (from PoC):
- Export registry: `Map<string, SymbolExport[]>` keyed by display name
- Import parsing: Regex patterns (95%+ coverage, no AST needed)
- Resolution timing: Build-time (not query-time) for zero query overhead
- Performance: 10-15ms build overhead, <500KB memory, <1ms query time

**Extension Rule**: To add new import syntax, add regex pattern to `import-parser.ts` (limit 75 lines). Resolver automatically handles new types.

**Implementation Tasks**:
1. `import-parser.ts` (75 lines) - Import statement extraction
2. `symbol-resolver.ts` (200 lines) - Resolution orchestration
3. Modify `symbol-indexer.ts` (+50 lines) - Integrate resolver
4. Modify `cli.ts` (+30 lines) - Construct and pass resolver
5. Test suite - Unit + integration tests

**Integration Points**:
- `scip-loader.ts`: No changes (existing `loadMultipleScipFiles()` used)
- `symbol-indexer.ts`: Accept optional resolver, resolve "local N" at index time
- `query-engine.ts`: No changes (works with resolved symbols)
- `cli.ts`: Construct resolver, pass to `buildMergedIndex()`

**Success Criteria**:
- [ ] Cross-package `--from` queries work correctly
- [ ] Both package and relative imports supported
- [ ] Resolution build time <50ms for 3 SCIP files
- [ ] All existing tests pass (no regression)
- [ ] New test coverage for resolver and import parser
## 5. Verification
### How to Verify Success
- **Real-world validation**: Test on `markdown-ticket/` project with known `Ticket` interface usages
  - `shared/models/Ticket.ts` exports `Ticket` interface
  - Verify usages found in `shared/`, `src/`, `server/`, `mcp-server/`, `domain-contracts/`
  - Verify no false positives from same-named symbols in other files
- **Synthetic tests**: Edge cases (missing SCIP, unknown symbols, overloaded functions)
- **Output validation**: Text format matches grep pattern, JSON format is parseable
- **Performance verification**: Measure query time on full project SCIP index (< 1 sec target)
### Session 2025-12-30
- Q: Where should the SCIP search tool code live? → A: in ./src
- Q: What should the CLI command name be? → A: scip-find
- Q: What output formats should scip-find support? → A: Text output, JSON output
- Q: Should verification use the existing markdown-ticket project as test data? → A: Both approaches

**Applied to sections:**
- Open Questions: Resolved technology, architecture, integration questions with concrete decisions
- Affected Areas: Added `./src` as project location
- Acceptance Criteria: CLI name `scip-find`, output formats (text + JSON)
- Verification: Test approach (real + synthetic)

### Phase 1: Foundation ✅ COMPLETE
- Task 1.1: `symbol-roles.ts` (67 lines, limit 75) - 19 tests passing ✅
- Task 1.2: `symbol-parser.ts` (55 lines, limit 100) - 22 tests passing ✅
- Task 1.3: `scip-loader.ts` (112 lines, limit 150) - 10 tests passing ✅
- Task 1.4: `symbol-indexer.ts` (122 lines, limit 200) - 12 tests passing ✅

### Phase 2: Query Core ✅ COMPLETE
- Task 2.1: Symbol search by name - Implemented
- Task 2.2: --from file filtering - Implemented
- Task 2.3: --folder filtering - Implemented
- Task 2.4: Package-aware distinction - Implemented
- Total: `query-engine.ts` (92 lines, limit 250) - 28 tests passing ✅

**Total: 91 unit tests passing**

### Phase 3: CLI + Output (Pending)
- CLI entry point with commander.js
- Text formatter (grep-like output)
- JSON formatter (structured output)
- Integration tests with real SCIP files

### Phase 4: Hardening (Pending)
- Edge case tests
- Synthetic SCIP fixtures
- Error handling validation